# Lighthouse

Простое приложение на Python/Tkinter для управления профилями и туннелями.

## Установка и запуск

1. Убедитесь, что у вас установлен Python 3.
2. Установите зависимости (для данного прототипа внешние зависимости не требуются).
3. Запустите приложение:
   ```bash
   python -m lighthouse_app.ui
   ```

### Настройка окна

В файле `config.ini` в секции `[ui]` задаются размеры главного окна.
Параметры `width` и `height` определяют стартовую геометрию, а
`min_width` и `min_height` — минимально допустимые значения, до которых
окно можно уменьшать.
При закрытии приложения текущая ширина и высота окна сохраняются в `config.ini`
и будут использованы при следующем запуске.

## Сборка проекта с помощью PyInstaller

[PyInstaller](https://pyinstaller.org) позволяет упаковать приложение в один
исполняемый файл для Windows. Ниже приведён базовый процесс сборки.

1. Установите PyInstaller:
   ```bash
   pip install pyinstaller
   ```
2. В каталоге проекта выполните команду сборки:
   ```bash
   pyinstaller --onefile --windowed --name Lighthouse lighthouse_app/ui.py
   ```
3. Готовый файл появится в каталоге `dist` с именем `Lighthouse.exe`.
4. Положите рядом с исполняемым файлом конфигурацию `config.ini` и, при
   необходимости, `pane_layout.ini`. При желании их можно включить в сборку
   опцией `--add-data "config.ini;."`.
5. Запустите итоговый файл двойным щелчком либо из командной строки.

## Тестирование

Тесты используют значения из файла `config.ini` для проверки корректности конфигурации.
Запуск тестов:

```bash
pytest
```

## Структура интерфейса

- **Profiles**: список профилей слева, кнопки *New Profile*, *Edit Profile* и *Delete Profile* снизу.
- **Tunnels**: список туннелей по центру. Под списком расположены
  две группы кнопок:
  - управление: *New Tunnel*, *Edit Tunnel*, *Delete Tunnel*;
  - действия: *Start Tunnel*, *Stop Tunnel*.
- Окно добавления и редактирования туннелей шире по умолчанию, подписи полей
  выровнены и все поля ввода растягиваются по ширине окна.
- **Tunnel Info and Status**: информация о текущем туннеле справа сверху. При
  выборе туннеля здесь отображается готовая команда SSH и список связанных
  DNS имён.
- **Log**: область логов справа снизу.
- В ней отображаются сообщения о запуске и остановке туннелей.
- Область только для чтения: пользователь не может менять её содержимое, записи делает лишь программа.
- **Settings**: кнопка с настройками внизу справа.
- **Manage SSH Key**: кнопка управления SSH ключами рядом с *Settings*.

Панели можно изменять по ширине перетягиванием разделителей. Минимальный
размер разделителей задаётся параметром `sash_width` в `config.ini`.

Ширина колонок сохраняется между запусками в файле `pane_layout.ini`. Этот
файл предназначен для пользовательских настроек и добавлен в `.gitignore`.

Каждое действие пользователя логируется в файл `app.log` для упрощения отладки.

## Работа с профилями

Профили позволяют сохранять имя пользователя, выделенный IP адрес и путь к SSH
ключу. Пользователь может выбрать автоматическое назначение адреса или
ввести его вручную. При создании нового профиля все параметры вводятся в одном
окне, что упрощает процесс для начинающих пользователей. При автоматическом
выборе используется диапазон `127.1.1.0/24`, адреса в нём не повторяются. Статус
флажка «Assign IP automatically» сохраняется вместе с профилем: если он
установлен, поле IP остаётся неактивным и после перезапуска программы. Данные
профилей хранятся в файле `profiles.json`, расположенном рядом с программой.
Файл добавлен в `.gitignore`, поэтому его содержимое относится к
пользовательским данным. Профиль можно изменить через кнопку **Edit Profile**,
где доступны поля для редактирования имени, IP адреса и пути к ключу. Удаление
профиля выполняется кнопкой **Delete Profile** или программно, используя
функцию `delete_profile` из модуля `profiles`.

## Работа с туннелями

Туннели позволяют пробрасывать локальный порт на удалённый хост. При создании
туннеля доступны следующие параметры:

- **SSH host** — сервер, к которому устанавливается SSH подключение.
- **Username** — имя пользователя для SSH.
- **SSH port** — порт SSH сервера (по умолчанию `22`).
- **Local port** — локальный порт для проброса.
- **Remote host** — адрес удалённого сервиса.
- **Remote port** — порт удалённого сервиса.
- **DNS names** — необязательное поле. Позволяет указать несколько понятных
  имён сервиса, которые будут сохраняться вместе с туннелем.

  Для использования указанных DNS записей необходимо активировать опцию
  **Enable DNS Override**. Если опция отключена, имена остаются в списке,
  но при запуске туннеля файл `hosts` не изменяется.

Список DNS можно оставить пустым. Все действия с туннелями доступны через
кнопки **New Tunnel**, **Edit Tunnel** и **Delete Tunnel**.

Запуск и остановка происходят через кнопки **Start Tunnel** и **Stop Tunnel**.
При запуске в файл `hosts` добавляется блок с DNS именами из параметров
туннеля, указывающий на IP адрес выбранного профиля. В Windows файл `hosts`
расположен по пути `C:/Windows/System32/drivers/etc/hosts`. Добавление
происходит только если включена опция **Enable DNS Override**. После остановки
туннеля этот блок автоматически удаляется.
Для установления соединения используется библиотека `sshtunnel`. Локальная
сторона привязывается к IP-адресу, указанному в выбранном профиле, а отпечаток
ключа сервера принимается автоматически.
